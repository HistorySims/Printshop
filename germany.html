<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Press & Profit ‚Äî Germany (1517)</title>

  <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root{
      --btnBg: rgba(10,10,12,0.75);
      --btnBr: rgba(255,255,255,0.28);

      --paper: rgba(245,236,220,0.92);

      --outline: rgba(0,255,255,0.85);

      --spineBg: rgba(245,240,232,0.92);
      --spineInk: rgba(30,25,20,0.95);
      --spineBr: rgba(0,0,0,0.30);
    }
    *{ box-sizing:border-box; }
    body{ margin:0; height:100vh; overflow:hidden; background:#000; font-family: Georgia, serif; }

    .frame{
      position:relative;
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#000;
    }

    .stage{
      position:relative;
      width:100%;
      height:100%;
      max-width:1200px;
      max-height:100vh;
    }

    .backdrop{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:contain;
      object-position:center;
      pointer-events:none;
      user-select:none;
    }

    .vignette{
      position:absolute;
      inset:0;
      pointer-events:none;
      background:
        radial-gradient(1200px 700px at 30% 20%, rgba(0,0,0,0.08), rgba(0,0,0,0.35)),
        linear-gradient(180deg, rgba(0,0,0,0.14), rgba(0,0,0,0.28));
    }

    .topbar{
      position:absolute;
      left:0; right:0; top:0;
      z-index:10;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      color:#fff;
      font-size:14px;
      background: rgba(0,0,0,0.45);
      backdrop-filter: blur(3px);
    }
    .topbar .group{ display:flex; gap:8px; align-items:center; min-width: 160px; }
    .topbar .center{ flex:1; text-align:center; font-weight:bold; opacity:0.95; }

    button{
      font-family: Georgia, serif;
      padding:7px 10px;
      background: var(--btnBg);
      color:#fff;
      border:1px solid var(--btnBr);
      border-radius:10px;
      cursor:pointer;
    }
    button:hover{ border-color: rgba(255,255,255,0.40); }

    .box{ position:absolute; z-index:6; border-radius:12px; }

    /* Calibration visuals */
    .calOutline{
      outline: 2px dashed var(--outline);
      background: rgba(0,255,255,0.08);
      cursor: move;
    }
    .calTag{
      position:absolute;
      left:6px;
      top:6px;
      font-size:10px;
      color:#fff;
      text-shadow: 0 2px 8px rgba(0,0,0,0.65);
      pointer-events:none;
      user-select:none;
    }
    .hint{
      position:absolute;
      left:10px;
      bottom:10px;
      z-index:60;
      background: rgba(0,0,0,0.55);
      color:#fff;
      border:1px solid rgba(255,255,255,0.25);
      border-radius:12px;
      padding:10px;
      font-size:12px;
      max-width: 560px;
      line-height:1.35;
    }

    /* Scroll / order card */
    .scrollCard{
      width:100%;
      height:100%;
      border-radius:16px;
      background: rgba(245,236,220,0.70);
      border: 1px solid rgba(0,0,0,0.18);
      box-shadow: 0 16px 36px rgba(0,0,0,0.30);
      padding:12px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:6px;
      color:#000;
      pointer-events:none;
    }
    .scrollCard .h{ font-weight:bold; font-size:14px; }
    .scrollCard .p{ font-size:13px; color: rgba(0,0,0,0.72); }
    .scrollCard .pat{ font-size:14px; font-weight:bold; letter-spacing:1px; }

    /* Type area */
    .typeCard{
      width:100%;
      height:100%;
      border-radius:14px;
      background: rgba(245,236,220,0.80);
      border: 1px solid rgba(0,0,0,0.22);
      box-shadow: 0 18px 40px rgba(0,0,0,0.35);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      color:#000;
    }
    .typeHead{ display:flex; justify-content:space-between; gap:10px; }
    .typeHead .sub{ font-size:12px; color: rgba(0,0,0,0.70); }

    .bed, .tray{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      padding:10px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,0.25);
      background: rgba(255,255,255,0.85);
      min-height:60px;
      align-items:center;
    }
    .block{
      width:44px;
      height:44px;
      border-radius:10px;
      background: rgba(93,64,55,0.92);
      border:1px solid rgba(0,0,0,0.35);
      box-shadow: 0 10px 18px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.18);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:bold;
      font-size:18px;
      cursor:pointer;
      user-select:none;
    }

    /* Shelves (visual: subtle edge highlights only) */
    .shelfBay{
      width:100%;
      height:100%;
      border-radius:10px;
      background: rgba(0,0,0,0.02);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,0.12),
        inset 0 -16px 18px rgba(0,0,0,0.14);
      overflow:hidden;
      position:relative;
    }

    /* ‚Äúspines‚Äù */
    .spines{
      position:absolute;
      left:6px; right:6px;
      top:8px; bottom:6px;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:6px;
      align-content:end;
    }
    .spine{
      height: 26px;
      border-radius:6px;
      background: var(--spineBg);
      border:1px solid var(--spineBr);
      box-shadow: 0 6px 10px rgba(0,0,0,0.22), inset 0 1px 0 rgba(255,255,255,0.55);
      color: var(--spineInk);
      font-size:8px;
      line-height:1.1;
      padding:3px 5px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      cursor:pointer;
      user-select:none;
    }
    .spine .t{ font-weight:bold; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
    .spine .x{ align-self:flex-end; font-size:10px; opacity:0.75; }

    /* Orders overlay */
    .overlay{
      position:absolute;
      inset:0;
      z-index:50;
      background: rgba(0,0,0,0.72);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:12px;
    }
    .modal{
      width:min(560px, 96vw);
      max-height:86vh;
      overflow:auto;
      background: rgba(245,236,220,0.96);
      border: 3px double rgba(0,0,0,0.85);
      box-shadow: 0 22px 60px rgba(0,0,0,0.55);
      padding:14px;
      border-radius:14px;
      color:#000;
    }
    .job{
      border: 1px solid rgba(0,0,0,0.35);
      background: rgba(255,255,255,0.75);
      border-radius:12px;
      padding:10px;
      margin-bottom:10px;
      cursor:pointer;
    }
    .job:hover{ background: rgba(255,255,255,0.92); }
    .job small{ color: rgba(0,0,0,0.70); }
  </style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">
  const JOBS = [
    { id: 1, name:"The 95 Theses", pattern:["T","H","E","S"], sellRate:0.08 },
    { id: 2, name:"Indulgence Form", pattern:["I","N","D","L"], sellRate:0.03 },
    { id: 3, name:"Satirical Woodcut", pattern:["H","A","H","A"], sellRate:0.05 },
    { id: 4, name:"Ballad Sheet", pattern:["L","I","E","D"], sellRate:0.02 },
    { id: 5, name:"Donatus (Latin Grammar)", pattern:["D","O","N","A"], sellRate:0.01 },
  ];
  const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2);

  const DEFAULT_LAYOUT = {
    scroll:  { x:0.07, y:0.17, w:0.52, h:0.22 },
    type:    { x:0.07, y:0.50, w:0.56, h:0.40 },
    shelf1:  { x:0.69, y:0.20, w:0.26, h:0.17 },
    shelf2:  { x:0.69, y:0.40, w:0.26, h:0.17 },
    shelf3:  { x:0.69, y:0.60, w:0.26, h:0.17 },
    shelf4:  { x:0.69, y:0.80, w:0.26, h:0.17 },
  };

  const LS_KEY = "pp_germany_layout_v2";

  function loadLayout(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return DEFAULT_LAYOUT;
      const obj = JSON.parse(raw);
      return { ...DEFAULT_LAYOUT, ...obj };
    }catch(e){ return DEFAULT_LAYOUT; }
  }
  function saveLayout(layout){ localStorage.setItem(LS_KEY, JSON.stringify(layout)); }
  const clamp01 = (n) => Math.max(0, Math.min(1, n));

  function App(){
    const SHELF_CAP = 20;
    const [wallet, setWallet] = React.useState(0);
    const [ordersOpen, setOrdersOpen] = React.useState(false);

    const [job, setJob] = React.useState(null);
    const [tray, setTray] = React.useState([]);
    const [bed, setBed] = React.useState([]);

    const [stock, setStock] = React.useState([]);

    const [calibrate, setCalibrate] = React.useState(false);
    const [layout, setLayout] = React.useState(()=>loadLayout());
    const [selectedKey, setSelectedKey] = React.useState("shelf1");

    const stageRef = React.useRef(null);
    const dragRef = React.useRef(null);

    // Sales loop
    React.useEffect(()=>{
      const t = setInterval(()=>{
        setStock(prev=>{
          if(prev.length === 0) return prev;
          const next = [...prev];
          for(let i=next.length-1;i>=0;i--){
            if(Math.random() < next[i].sellRate){
              setWallet(w => w + 1);
              next.splice(i, 1);
            }
          }
          return next;
        });
      }, 450);
      return ()=>clearInterval(t);
    },[]);

    // Arrow-key nudge in calibration mode
    React.useEffect(()=>{
      function onKey(e){
        if(!calibrate) return;
        const key = e.key;
        const big = e.shiftKey ? 0.01 : 0.002; // normalized nudge
        if(!["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(key)) return;

        e.preventDefault();
        setLayout(prev=>{
          const b = prev[selectedKey];
          if(!b) return prev;
          let dx=0, dy=0;
          if(key==="ArrowLeft") dx=-big;
          if(key==="ArrowRight") dx=big;
          if(key==="ArrowUp") dy=-big;
          if(key==="ArrowDown") dy=big;
          return {
            ...prev,
            [selectedKey]: { ...b, x: clamp01(b.x+dx), y: clamp01(b.y+dy) }
          };
        });
      }
      window.addEventListener("keydown", onKey, { passive:false });
      return ()=>window.removeEventListener("keydown", onKey);
    }, [calibrate, selectedKey]);

    function shuffle(arr){
      const a = [...arr];
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    function acceptJob(j){
      setJob(j);
      setTray(shuffle(j.pattern));
      setBed([]);
      setOrdersOpen(false);
    }

    function clickBlock(ch){
      if(!job) return;

      const nextBed = [...bed, ch];
      setBed(nextBed);

      const idx = tray.indexOf(ch);
      const nextTray = [...tray];
      if(idx >= 0) nextTray.splice(idx, 1);
      setTray(nextTray);

      if(nextBed.length === 4){
        const ok = nextBed.every((c,i)=>c === job.pattern[i]);
        if(ok){
          setStock(prev=>{
            if(prev.length >= SHELF_CAP) return prev;
            return [...prev, { ...job, uid: uid() }];
          });
        }
        setBed([]);
        setTray(shuffle(job.pattern));
      }
    }

    function trash(uidToRemove){
      setStock(prev => prev.filter(x => x.uid !== uidToRemove));
    }

    const bays = React.useMemo(()=>{
      const perBay = Math.ceil(SHELF_CAP / 4); // 5 if 20
      const out = [[],[],[],[]];
      for(let i=0;i<stock.length;i++){
        out[Math.floor(i / perBay)].push(stock[i]);
      }
      return out;
    }, [stock]);

    function boxStyle(b){
      return {
        left: (b.x*100) + "%",
        top: (b.y*100) + "%",
        width: (b.w*100) + "%",
        height: (b.h*100) + "%"
      };
    }

    function onMouseDownBox(key, e){
      if(!calibrate || !stageRef.current) return;
      setSelectedKey(key);
      const rect = stageRef.current.getBoundingClientRect();
      dragRef.current = {
        key,
        startMouse: { x: e.clientX, y: e.clientY },
        startBox: { ...layout[key] },
        rect
      };
      e.preventDefault();
    }

    React.useEffect(()=>{
      function onMove(e){
        if(!dragRef.current) return;
        const { key, startMouse, startBox, rect } = dragRef.current;
        const dx = (e.clientX - startMouse.x) / rect.width;
        const dy = (e.clientY - startMouse.y) / rect.height;

        setLayout(prev=>{
          const next = { ...prev };
          next[key] = { ...next[key], x: clamp01(startBox.x + dx), y: clamp01(startBox.y + dy) };
          return next;
        });
      }
      function onUp(){ dragRef.current = null; }
      window.addEventListener("mousemove", onMove);
      window.addEventListener("mouseup", onUp);
      return ()=>{
        window.removeEventListener("mousemove", onMove);
        window.removeEventListener("mouseup", onUp);
      };
    }, [layout]);

    function saveCal(){
      saveLayout(layout);
      setCalibrate(false);
    }
    function resetCal(){
      setLayout(DEFAULT_LAYOUT);
      saveLayout(DEFAULT_LAYOUT);
    }

    return (
      <div className="frame">
        <div className="stage" ref={stageRef}>
          <img className="backdrop" src="IMG_4315.png" alt="Backdrop"/>
          <div className="vignette"></div>

          <div className="topbar">
            <div className="group">
              <button onClick={()=>window.location.href="index.html"}>Exit</button>
              <button onClick={()=>setOrdersOpen(true)}>Orders</button>
            </div>

            <div className="center">Germany (1517)</div>

            <div className="group" style={{justifyContent:"flex-end"}}>
              <div style={{fontWeight:"bold"}}>üí∞ {wallet}</div>
              <button onClick={()=>setCalibrate(c=>!c)}>{calibrate ? "Editing" : "Calibrate"}</button>
              {calibrate && <button onClick={saveCal}>Save</button>}
              {calibrate && <button onClick={resetCal}>Reset</button>}
            </div>
          </div>

          {/* Scroll */}
          <div
            className={"box" + (calibrate ? " calOutline" : "")}
            style={boxStyle(layout.scroll)}
            onMouseDown={(e)=>onMouseDownBox("scroll", e)}
          >
            {calibrate && <div className="calTag">SCROLL</div>}
            <div className="scrollCard">
              <div className="h">Today‚Äôs order</div>
              <div className="p">{job ? job.name : "Open Orders to choose a job."}</div>
              <div className="p">Set pattern:</div>
              <div className="pat">{job ? job.pattern.join("") : "‚Äî"}</div>
              <div className="p" style={{fontSize:12, opacity:0.8}}>
                Shelf capacity: {stock.length}/20
              </div>
            </div>
          </div>

          {/* Type */}
          <div
            className={"box" + (calibrate ? " calOutline" : "")}
            style={boxStyle(layout.type)}
            onMouseDown={(e)=>onMouseDownBox("type", e)}
          >
            {calibrate && <div className="calTag">TYPE</div>}
            <div className="typeCard">
              <div className="typeHead">
                <div>
                  <b>Composing</b>
                  <div className="sub">{job ? job.name : "Choose an order first"}</div>
                </div>
                <div className="sub">{job ? "Click blocks to set type" : ""}</div>
              </div>

              <div>
                <div style={{fontSize:12, marginBottom:6, color:"rgba(0,0,0,0.75)"}}>Print bed</div>
                <div className="bed">
                  {bed.length === 0 && <div style={{opacity:0.65, fontSize:12}}>Place 4 blocks‚Ä¶</div>}
                  {bed.map((c,i)=>(
                    <div key={i} className="block" style={{cursor:"default"}}>{c}</div>
                  ))}
                </div>
              </div>

              <div>
                <div style={{fontSize:12, marginBottom:6, color:"rgba(0,0,0,0.75)"}}>Type tray</div>
                <div className="tray">
                  {tray.length === 0 && <div style={{opacity:0.65, fontSize:12}}>‚Äî</div>}
                  {tray.map((c,i)=>(
                    <div key={i} className="block" onClick={()=>clickBlock(c)}>{c}</div>
                  ))}
                </div>
              </div>

              <div style={{fontSize:12, color:"rgba(0,0,0,0.70)"}}>
                Correct type ‚Üí one copy is stocked on the shelf.
              </div>
            </div>
          </div>

          {/* Shelves */}
          {["shelf1","shelf2","shelf3","shelf4"].map((key, idx)=>(
            <div
              key={key}
              className={"box" + (calibrate ? " calOutline" : "")}
              style={boxStyle(layout[key])}
              onMouseDown={(e)=>onMouseDownBox(key, e)}
            >
              {calibrate && <div className="calTag">SHELF {idx+1}</div>}
              <div className="shelfBay">
                <div className="spines">
                  {bays[idx].map(item=>(
                    <div
                      key={item.uid}
                      className="spine"
                      onClick={()=>trash(item.uid)}
                      title="Click to trash"
                    >
                      <div className="t">{item.name}</div>
                      <div className="x">√ó</div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          ))}

          {/* Orders overlay */}
          {ordersOpen && (
            <div className="overlay" onClick={()=>setOrdersOpen(false)}>
              <div className="modal" onClick={(e)=>e.stopPropagation()}>
                <h3>Incoming Orders</h3>
                <div style={{fontSize:12, color:"rgba(0,0,0,0.72)", marginBottom:10}}>
                  Click an order to accept.
                </div>
                {JOBS.map(j=>(
                  <div className="job" key={j.id} onClick={()=>acceptJob(j)}>
                    <div style={{fontWeight:"bold"}}>{j.name}</div>
                    <small>Pattern: {j.pattern.join("")}</small>
                  </div>
                ))}
              </div>
            </div>
          )}

          {calibrate && (
            <div className="hint">
              <b>Calibration mode (for exact match)</b><br/>
              Drag a box. Use arrow keys to nudge it.<br/>
              Hold <b>Shift</b> for bigger nudges. Press <b>Save</b> when perfect.
            </div>
          )}
        </div>
      </div>
    );
  }

  ReactDOM.render(<App/>, document.getElementById("root"));
</script>
</body>
</html>
